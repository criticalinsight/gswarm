# GleamDB v2.4.0 Release Learnings üßôüèæ‚Äç‚ôÇÔ∏è

> Rich Hickey: "Every system needs a maintenance phase where you learn what the abstractions actually taught you."

## Release Integration Learnings

### 1. `EntityId` Unwrapping Is a Recurring Pain Point ‚Äî ‚úÖ RESOLVED
**Problem**: `gleamdb.traverse` accepts `Int` internally but `gleamdb.pull` works with `fact.Eid` which wraps `EntityId`. The mismatch caused a type error during initial integration.

**Resolution**: Added `gleamdb.resolve_eid(db, eid) -> Int` public helper. `traverse()` now uses it internally.

**Hickey Warning**: ‚ö†Ô∏è The `EntityId` wrapper exists for good reason ‚Äî it de-complects identity from raw integers. But the API boundary should handle the unwrapping, not the consumer.

---

### 2. `TraversalStep` Imports Require Destructuring ‚Äî ‚úÖ RESOLVED (Partially)
**Problem**: Consumer code needs `import gleamdb/shared/types.{Out, In}` to use the DSL. This leaks internal module structure.

**Resolution**: Added `gleamdb.out(attr)` and `gleamdb.step_in(attr)` wrapper functions + `TraversalStep`/`TraversalExpr` type re-exports.

**‚ö†Ô∏è Gleam Limitation**: `pub const Out = types.Out` does NOT work in Gleam ‚Äî constructors with uppercase names cannot be aliased as constants. Wrapper functions (`pub fn out()`) are the idiomatic solution. Direct destructuring `import gleamdb/shared/types.{Out}` remains valid for pattern matching.

---

### 3. Graph Traversal vs Datalog: Choosing the Right Tool
**Pattern Observed**: In `graph_intel.gleam`, complex graph analyses (PageRank, Cycle Detection, SCC) remain better expressed as Datalog predicates. The traverse DSL shines for **simple multi-hop relationship chasing** (1-3 hops).

**Decision Matrix for Consumers**:
| Use Case | Tool | Why |
|---|---|---|
| "Who are Alice's friends' friends?" | `traverse` | Simple hop chain |
| "Find all trading rings" | `q.cycle_detect` | Algorithm-based, not hop-based |
| "PageRank the network" | `q.pagerank` | Global computation |
| "Show me the market influence chain" | `traverse` | Linear edge chasing |

---

### 4. Prefetch Config Is Opt-In but Should Be Default ‚Äî ‚úÖ RESOLVED
**Observation**: No child project was using `prefetch_enabled: True` because the Config constructor defaults to `False`. Production systems like gswarm would benefit from prefetching by default.

**Resolution**: Changed default to `True` in `transactor.gleam`. All 125 tests pass.

---

### 5. Zero-Copy Threshold Needs Tuning Guidance
**Observation**: The default `zero_copy_threshold` of 10,000 is reasonable for analytical workloads but could be too aggressive for interactive queries that expect structured `PullResult` types.

**Recommendation**: Document clear guidance:
- `1,000` ‚Äî Aggressive zero-copy (analytical/batch workloads)
- `10,000` ‚Äî Default (balanced)
- `100,000` ‚Äî Conservative (interactive apps expecting structured results)

---

### 6. `gclaw/` Has a Stale Forked Copy of GleamDB ‚Äî ‚úÖ RESOLVED
**Problem**: `gclaw/` contains a **full fork** of GleamDB source files (engine, index, ets, q, fact). It does NOT import GleamDB as a dependency ‚Äî it has its own copy. This means v2.4.0 features are NOT available in gclaw without a full re-sync.

**Resolution**: Rsynced canonical GleamDB v2.4.0 into `gclaw/src/gleamdb/`. Removed deprecated `storage/disk`, `transactor.create_bm25_index`, `register_index_adapter`, `create_index`. Migrated `engine.run` calls to `gleamdb.query_state`. All 5 tests pass, 0 warnings.

**Recommended Process for Future Releases**:
```bash
# From project root, sync canonical source to child project vendor
rsync -av --delete --exclude='gleamcms/' src/gleamdb/ <child>/src/gleamdb/
rsync -av src/gleamdb_*_ffi.erl src/gleam_erl_ffi.erl <child>/src/
rm -f <child>/src/gleamdb/gleamcms.gleam  # Remove CMS entrypoint
```

---

### 7. Sly (Rust) Cannot Directly Use GleamDB Features
**Observation**: Sly is a Rust/Tauri app. It cannot call Gleam functions directly. The Tidewave ACP proxy layer is the bridge. New GleamDB features like `traverse` should be exposed via ACP methods (e.g., `_tidewave.ai/gleam/traverse`) for Sly to consume.

**Action Required**: Add an ACP handler for `traverse` in `tidewave-core/src/acp_proxy.rs`.

---

## Summary Table

| Learning | Severity | Status |
|---|---|---|
| EntityId unwrapping | Medium | ‚úÖ `resolve_eid` added |
| TraversalStep import path | Low | ‚úÖ Re-exported from `gleamdb` |
| Traverse vs Datalog | Info | ‚úÖ Decision matrix documented |
| Prefetch default | Medium | ‚úÖ Default changed to `True` |
| Zero-copy threshold guidance | Low | Tuning docs pending |
| gclaw fork drift | High | ‚úÖ Vendor synced v2.4.0 |
| Sly ACP bridge | High | Pending ‚Äî needs Rust ACP handler |
